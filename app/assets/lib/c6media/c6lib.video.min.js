"use strict";angular.module("c6lib.video",[]).service("c6videoService",["$document","$window",function(a,b){this.bestFormat=function(b){var c=[],d=[],e=a[0].createElement("VIDEO");if(b=b?b:this.validFormats,"[object Array]"!==Object.prototype.toString.call(b))throw new TypeError("You must pass in an array of format strings.");return b.forEach(function(a){var b=e.canPlayType(a);"probably"===b?d.push(a):"maybe"===b&&c.push(a)}),d.length?d[0]:c[0]},this.validFormats=["video/mp4","video/webm","video/ogg"],this.extensionForFormat=function(a){return a.split("/").pop()},this.formatForExtension=function(a){return"video/"+a},this.isChrome=b.chrome?!0:!1,this.isIPhone=b.navigator.userAgent.match(/iPhone/)?!0:!1,this.isSafari=-1!==b.navigator.userAgent.indexOf("Safari")&&-1===b.navigator.userAgent.indexOf("Chrome"),this.totalTimeInRanges=function(a){for(var b=0,c=0;c<a.length;c++)b+=a.end(c)-a.start(c);return b}}]).controller("C6VideoController",["$scope","$element","$attrs","$document","$timeout","c6videoService","$log",function(a,b,c,d,e,f,g){var h={},i=function(b){var c=b.type,d=h[c];d.handlers.forEach(function(c){a.$apply(c(b,k))}),d.emit&&a.$emit("c6video-"+b.type,k)},j=!1,k={id:c.id,player:b[0],hasPlayed:function(){return j},on:function(a,b,c){a="[object Array]"===Object.prototype.toString.call(a)?a:[a],c="undefined"!=typeof c?c:!1,b||(c=!0);var d=this.player;return a.forEach(function(a){h[a]?b&&h[a].handlers.push(b):(h[a]={handlers:b?[b]:[],emit:c},d.addEventListener(a,i,!1))}),this},off:function(a){a="[object Array]"===Object.prototype.toString.call(a)?a:[a];var b=this.player;return a.forEach(function(a){b.removeEventListener(a,i,!1),delete h[a]}),this},src:function(a){var b=this.player,c=f.bestFormat();if(!a)return b.src&&this.regenerate(),!1;if(f.isIPhone&&(this.regenerate(),b=this.player),"string"==typeof a){var d=a.split(".").pop(),e=f.validFormats;if(-1===e.indexOf(f.formatForExtension(d))){if(!c)throw new Error("This player can't player any availabe valid formats.");b.src=a+"."+f.extensionForFormat(c)}else b.src=a}else if("object"==typeof a){var g=[];a.forEach(function(a){g.push(a.type)}),a.forEach(function(a){a.type===c&&(b.src=a.src)})}b.load()},regenerate:function(){g.log("c6video: regenerating player.");for(var a,b=d[0].createElement("VIDEO"),c=this.player,e=0,f=c.attributes.length;f>e;e++)a=c.attributes[e],"currentTime"!==a.name&&"src"!==a.name&&b.setAttribute(a.name,a.value);for(var k in h)h.hasOwnProperty(k)&&b.addEventListener(k,i,!1);c.parentNode.replaceChild(b,c),this.player=b,j=!1},bufferedPercent:function(){var a=this.player;if(a.duration){var b=Math.ceil(f.totalTimeInRanges(a.buffered)),c=Math.round(100*(b/Math.ceil(a.duration)))/100;return c}return 0},size:function(a,b){var c=this.player;c.width=a,c.height=b},fullscreen:function(a){var b=this.player;return a?b.requestFullscreen?(b.requestFullscreen(),!0):b.mozRequestFullScreen?(b.mozRequestFullScreen(),!0):b.webkitRequestFullscreen?(b.webkitRequestFullscreen(),!0):b.msRequestFullscreen?(b.msRequestFullscreen(),!0):!1:d[0].cancelFullScreen?(d[0].cancelFullScreen(),!0):d[0].webkitCancelFullScreen?(d[0].webkitCancelFullScreen(),!0):d[0].mozCancelFullScreen?(d[0].mozCancelFullScreen(),!0):d[0].msCancelFullScreen?(d[0].msCancelFullScreen(),!0):b.webkitExitFullscreen?(b.webkitExitFullscreen(),!0):!1}};a.$watch("c6Src()",function(a){k.src(a)}),a.$watch("c6Controls()",function(a){k.player.controls=a}),c.$observe("on",function(b){if(b){var c=b.split(",");c.forEach(function(b){var c=b.split(":"),d=c[0].trim(),e=c[1].trim().split("."),f=a.$parent;e.forEach(function(a){f=f[a]}),k.on(d,function(a,b){f(a,b)})})}}),k.on("play",function(){j=!0}),c.id?c.$observe("id",function(b){b&&(k.id=b,a.$emit("c6video-ready",k))}):a.$emit("c6video-ready",k),a.$on("$destroy",function(){a.$emit("c6video-destroyed",c.id)}),f.isChrome&&k.on("canplay",function(a,b){var c=b.player;c.muted=!0,c.play(),e(function(){c.pause(),c.currentTime=0,c.muted=!1},50)})}]).directive("c6video",[function(){return{controller:"C6VideoController",scope:{c6Src:"&",c6Controls:"&",on:"@",id:"@"}}}]);