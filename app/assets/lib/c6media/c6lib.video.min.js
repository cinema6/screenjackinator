"use strict";angular.module("c6lib.video",[]).service("c6videoService",["$document","$window",function(a,b){this.bestFormat=function(b){var c=[],d=[],e=a[0].createElement("VIDEO");if(b=b?b:this.validFormats,"[object Array]"!==Object.prototype.toString.call(b))throw new TypeError("You must pass in an array of format strings.");return b.forEach(function(a){var b=e.canPlayType(a);"probably"===b?d.push(a):"maybe"===b&&c.push(a)}),d.length?d[0]:c[0]},this.validFormats=["video/mp4","video/webm","video/ogg"],this.extensionForFormat=function(a){return a.split("/").pop()},this.formatForExtension=function(a){return"video/"+a},this.isChrome=b.chrome?!0:!1,this.isIPhone=navigator.userAgent.match(/iPhone/)?!0:!1,this.totalTimeInRanges=function(a){for(var b=0,c=0;c<a.length;c++)b+=a.end(c)-a.start(c);return b}}]).controller("C6VideoController",["$scope","$element","$attrs","$document","$timeout","c6videoService",function(a,b,c,d,e,f){var g={},h=function(b){var c=b.type,d=g[c];d.handlers.forEach(function(c){a.$apply(c(b,i))}),d.emit&&a.$emit("c6video-"+b.type,i)},i={id:c.id,player:b[0],on:function(a,b,c){a="[object Array]"===Object.prototype.toString.call(a)?a:[a],c="undefined"!=typeof c?c:!1,b||(c=!0);var d=this.player;return a.forEach(function(a){g[a]?b&&g[a].handlers.push(b):(g[a]={handlers:b?[b]:[],emit:c},d.addEventListener(a,h,!1))}),this},off:function(a){a="[object Array]"===Object.prototype.toString.call(a)?a:[a];var b=this.player;return a.forEach(function(a){b.removeEventListener(a,h,!1),delete g[a]}),this},src:function(a){var b=this.player,c=f.bestFormat();if(f.isIPhone&&(this.regenerate(),b=this.player),"["!==a.charAt(0)||"]"!==a.charAt(a.length-1)){var d=a.split(".").pop(),e=f.validFormats;if(-1===e.indexOf(f.formatForExtension(d))){if(!c)throw new Error("This player can't player any availabe valid formats.");b.src=a+"."+f.extensionForFormat(c)}else b.src=a}else{var g=JSON.parse(a),h=[];g.forEach(function(a){h.push(a.type)}),g.forEach(function(a){a.type===c&&(b.src=a.src)})}b.load()},regenerate:function(){for(var a,b=document.createElement("VIDEO"),c=this.player,d=0,e=c.attributes.length;e>d;d++)a=c.attributes[d],"currentTime"!==a.name&&(b[a.name]=a.value);c.parentNode.replaceChild(b,c),this.player=b},bufferedPercent:function(){var a=this.player;if(a.duration){var b=Math.ceil(f.totalTimeInRanges(a.buffered)),c=Math.round(100*(b/Math.ceil(a.duration)))/100;return c}return 0},size:function(a,b){var c=this.player;c.width=a,c.height=b},fullscreen:function(a){if(a){var b=this.player;return b.requestFullscreen?(b.requestFullscreen(),!0):b.mozRequestFullScreen?(b.mozRequestFullScreen(),!0):b.webkitRequestFullscreen?(b.webkitRequestFullscreen(),!0):b.msRequestFullscreen?(b.msRequestFullscreen(),!0):!1}return d[0].exitFullscreen?(d[0].exitFullscreen(),!0):d[0].mozExitFullscreen?(d[0].mozExitFullscreen(),!0):d[0].webkitExitFullscreen?(d[0].webkitExitFullscreen(),!0):d[0].msExitFullscreen?(d[0].msExitFullscreen(),!0):!1}};c.$observe("c6Src",function(a){a&&i.src(a)}),c.$observe("on",function(b){if(b){var c=b.split(",");c.forEach(function(b){var c=b.split(":"),d=c[0].trim(),e=c[1].trim().split("."),f=a.$parent;e.forEach(function(a){f=f[a]}),i.on(d,function(a,b){f(a,b)})})}}),a.$on("$destroy",function(){a.$emit("c6video-destroyed",c.id)}),a.$emit("c6video-ready",i),f.isChrome&&i.on("canplay",function(a,b){var c=b.player;c.muted=!0,c.play(),e(function(){c.pause(),c.currentTime=0,c.muted=!1},50)})}]).directive("c6video",[function(){return{controller:"C6VideoController",scope:{c6Src:"@",on:"@"}}}]);